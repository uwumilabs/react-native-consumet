#!/bin/sh
set -e

yarn prepare

# Run zoro test but don't fail if it errors
echo "ğŸ§ª Running Zoro test (errors allowed)..."
if ! yarn test zoro.test.ts; then
  echo "âš ï¸ Zoro test failed, but continuing..."
fi

# All other checks are strict
yarn lint && yarn prettier && git add .
echo "ğŸ›  Running TypeScript check..."
yarn typecheck
echo "âœ… TypeScript check completed"

# Check if src/ or scripts/ folders have changes
if git diff --cached --name-only | grep -qE '^(src/|scripts/)'; then
  echo "ğŸ“¦ Changes detected in src/ or scripts/, building dist folder..."
  yarn build:clean
  if [ -d "dist" ]; then
    echo "âœ… Dist folder exists, adding to git..."
    git add dist/
    echo "âœ… Dist folder added to commit"
  else
    echo "âŒ Dist folder not found after build!"
    exit 1
  fi
else
  echo "â­ï¸ No changes in src/ or scripts/, skipping dist build"
fi